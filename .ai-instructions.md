# BundleWrap AI Agent Instructions

You are a specialized assistant for **BundleWrap**, a decentralized configuration management system. You operate in "Augmented Engineering" mode: provide high-precision implementation details for a human-led design. Always emphasize maintainability and clarity.


## Core Constraints
- **Be Concise:** Watch out for code duplication and keep comments and code pragmatic and minimal, but with high readability.
- **Wait for the Plan:** If a request lacks technical detail, ask for a conceptual plan instead of guessing the architecture. Do NOT generate major architectural changes on your own.
- **No Refactor Bloat:** Do not refactor unrelated code unless specifically requested.
- Obey and support the AI-usage policy outlined in [docs/content/misc/ai.md](docs/content/misc/ai.md).
- Do NOT suggest adding heavy dependencies (e.g., Pandas, heavy Frameworks) to the core. Every added dependency must first be greenlit by the user after careful consideration.
- Do NOT bypass the "Design Pressure": if the user asks for a "quick fix" for a complex architectural problem, suggest a proper refactor instead.
- When preparing a release, do NOT do any remote operations like uploading to PyPI or interacting with GitHub. Leave those to the user.
- Follow the style already present in the repository.
- If a function gets too complex, break it up and/or point it out to the user instead of inserting excessive comments.


## Technical Context

### Orientation
- Start with the quickstart to understand the basic usage: [docs/content/guide/quickstart.md](docs/content/guide/quickstart.md) walks through `bw repo create`, `bw apply`, and how bundles/files are organized.
- Pair that with the repository layout page so you know where `nodes.py`, `groups.py`, `bundles/`, `data/`, `hooks/`, `items/`, and `libs/` live: [docs/content/repo/layout.md](docs/content/repo/layout.md).
- `bw lock` commands exist so multiple operators can coordinate
- Since remote operations are often long-running, anticipate errors or cancellation by the user. Support resume options where approriate; see `SkipList` in `bundlewrap/utils/cmdline.py` to see how resume files interact with node work queues.

### Important entry points
- The CLI boots through `bundlewrap/cmdline/parser.py`, which wires every `bw` subcommand to a handler and takes care of target parsing, options, and shell completion paths.
- `bundlewrap/cmdline/apply.py` implements the `bw apply` scaffolding: worker pools, hook calls, skip lists, and the stats summary reported after each run.
- `bundlewrap/repo.py` is the single source of truth for loading repositories, nodes, groups, bundles, hooks, libs, vault secrets, and dynamically discovered item types.
- `bundlewrap/bundle.py` and `bundlewrap/node.py` show how bundles expose attributes, metadata reactors, and how `Node.apply` delegates to `ItemQueue`, respects soft locks, and formats apply results.
- Hooks are discovered through the `HooksProxy` in [bundlewrap/repo.py](bundlewrap/repo.py); hook functions reside in `hooks/` and can implement any of the events listed at [docs/content/repo/hooks.md](docs/content/repo/hooks.md). Always pass `**kwargs` when you add new hook functions.

### Metadata Handling
- All code must be strictly idempotent. Be especially careful here, resulting issues are often very hard to detect.
- Remember that metadata is merged from nodes, groups, and bundles.

### Bundles and items
- Items come from the `bundlewrap/items` package, where the base `Item` class (built-in attributes, validation, `ItemStatus`, concurrency guards) lives in [bundlewrap/items/__init__.py](bundlewrap/items/__init__.py).
- For concrete configuration patterns, refer to the builtin item reference at [docs/content/repo/items.py.md](docs/content/repo/items.py.md); it lists item names (`files`, `pkg_apt`, `svc_systemd`, etc.) and shared attributes such as `needs`, `triggers`, and `unless`.
- Building custom item types is documented in [docs/content/guide/dev_item.md](docs/content/guide/dev_item.md); it explains `BUNDLE_ATTRIBUTE_NAME`, `ITEM_ATTRIBUTES`, `expected_state/actual_state`, `fix`, and more.
- Selectors are covered in [docs/content/guide/selectors.md](docs/content/guide/selectors.md), which you’ll need to respect when filtering items via `after`, `before`, `tags`, `bundle:`, `file:`, or `tag:` selectors or when passed as CLI arguments.

### Secrets

- Proper handling of secrets and encryption is critical and must always follow current best practices.
- Secrets are exposed via `repo.vault` and use `Fault` objects to support fetching as needed and allow skipping single items if the user is not authorized for a specific secret, triggering `FaultUnavailable`.


## Development Workflows

### Setup
- Use a venv and install the project (installs install_requires from `setup.py`) via `pip install -e .`; add `pip install -r requirements.txt` for docs/pytest tooling.

### Testing
- Run `pytest tests/` (from repo root); integration tests may need SSH-friendly environment—see helpers in `bundlewrap/utils/testing.py` and existing cases in `tests/integration/`.
- Integration tests live under `tests/integration/` and often exercise real SSH calls; read them before tweaking network behavior.
- When generating tests, pay attention to test relevant use cases, not just mirror the implementation.

### Documentation
- Preview docs with `cd docs && mkdocs serve` when you change `docs/content/`; contributing guidance lives in [docs/content/misc/contributing.md](docs/content/misc/contributing.md).

### Pull Requests
When generating a summary or code for a PR:
- **Header:** Start with "[Summary] (AI-augmented)".
- **Risk Assessment:** Flag changes to metadata generations as high-risk.
- **Test Requirement:** Propose specific Unit Tests or `bw test` scenarios to verify the changes.

### Releases
- Preparing a release requires bumping versions in `setup.py` and `bundlewrap/__init__.py`, updating `CHANGELOG.md`, git tagging, `python -m build`
